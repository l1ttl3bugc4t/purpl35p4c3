#!/bin/bash
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ  ๐พ purpl35p4c3 โข herramienta ofensiva by l1ttl3bugc4t ๐    โ
# โ  script: smb_check.sh                                   โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

#!/bin/bash

# Escaneo de SMB (puerto 445)
# Elaborado por Respuesta y Recuperaciรณn ๐ก๏ธ

TARGET=$1

if [ -z "$TARGET" ]; then
  echo "Uso: $0 <IP o dominio>"
  exit 1
fi

OUTPUT_DIR="smb_recon_$TARGET"
mkdir -p "$OUTPUT_DIR"

REPORT="$OUTPUT_DIR/smb_reporte.txt"
DATE=$(date)

echo "REPORTE DE ESCANEO SMB - $DATE" > "$REPORT"
echo "Objetivo: $TARGET" >> "$REPORT"
echo "-----------------------------------------" >> "$REPORT"

# 1. Detecciรณn de sistema operativo y dominio
echo "[+] Ejecutando smb-os-discovery..."
nmap -Pn -p445 --script smb-os-discovery "$TARGET" -oN "$OUTPUT_DIR/nmap_smb_os.txt"
echo ">>> INFORMACIรN DEL SISTEMA <<<" >> "$REPORT"
grep -Ei "OS|Computer name|Domain name|FQDN" "$OUTPUT_DIR/nmap_smb_os.txt" >> "$REPORT"
echo >> "$REPORT"

# 2. Enumeraciรณn de shares sin autenticaciรณn
echo "[+] Enumerando recursos compartidos (smbclient -N)..."
smbclient -L //$TARGET -N > "$OUTPUT_DIR/smbclient.txt" 2>/dev/null
echo ">>> RECURSOS COMPARTIDOS <<<" >> "$REPORT"
cat "$OUTPUT_DIR/smbclient.txt" >> "$REPORT"
echo >> "$REPORT"

# 3. Enumeraciรณn con enum4linux (si estรก instalado)
if command -v enum4linux &>/dev/null; then
  echo "[+] Ejecutando enum4linux..."
  enum4linux -a "$TARGET" > "$OUTPUT_DIR/enum4linux.txt"
  echo ">>> ENUM4LINUX (USUARIOS Y SHARES) <<<" >> "$REPORT"
  grep -E "Group:|User:" "$OUTPUT_DIR/enum4linux.txt" | head -n 15 >> "$REPORT"
  echo ">>> (ver archivo completo para mรกs info)" >> "$REPORT"
  echo >> "$REPORT"
else
  echo "[!] enum4linux no estรก instalado. Saltando." >> "$REPORT"
fi

# 4. Detecciรณn de vulnerabilidades conocidas
echo "[+] Buscando vulnerabilidades SMB..."
nmap -Pn -p445 --script smb-vuln* "$TARGET" -oN "$OUTPUT_DIR/nmap_smb_vuln.txt"
echo ">>> VULNERABILIDADES POSIBLES <<<" >> "$REPORT"
grep -Ei "VULNERABLE|State: VULNERABLE|Exploitable" "$OUTPUT_DIR/nmap_smb_vuln.txt" >> "$REPORT"
echo >> "$REPORT"

# 5. Uso de crackmapexec si estรก disponible
if command -v crackmapexec &>/dev/null; then
  echo "[+] Ejecutando crackmapexec SMB..."
  crackmapexec smb "$TARGET" > "$OUTPUT_DIR/crackmapexec.txt"
  echo ">>> CRACKMAPEXEC SMB <<<" >> "$REPORT"
  head -n 10 "$OUTPUT_DIR/crackmapexec.txt" >> "$REPORT"
  echo ">>> (ver archivo completo para mรกs info)" >> "$REPORT"
  echo >> "$REPORT"
else
  echo "[!] crackmapexec no estรก instalado. Saltando." >> "$REPORT"
fi

echo "[*] Reporte generado en: $REPORT"
cat "$REPORT"
